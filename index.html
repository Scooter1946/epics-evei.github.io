<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>Geofence Creator (Azure Maps)</title>

<!-- Azure Maps SDK -->
<link rel="stylesheet" href="https://atlas.microsoft.com/sdk/css/atlas.min.css">
<script src="https://atlas.microsoft.com/sdk/js/atlas.min.js?api-version=2.1"></script>

<style>
    /* Global Styles */
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f7fa;
        color: #2c3e50;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header Styles */
    .site-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #2980b9 100%);
        position: relative;
        color: white;
        padding: 40px 20px;
        margin: -20px -20px 20px -20px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .site-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            45deg,
            rgba(255,255,255,0.03) 0px,
            rgba(255,255,255,0.03) 1px,
            transparent 1px,
            transparent 4px
        );
        pointer-events: none;
    }

    .site-header h1 {
        margin: 0;
        font-size: 3.2em;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
        position: relative;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .site-header h1::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: rgba(255,255,255,0.5);
        border-radius: 2px;
    }

    /* Container Styles */
    .main-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .map-container {
        flex: 1;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .coordinates-container {
        width: 500px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }

    #myMap {
        width: 100%;
        height: 600px;
    }

    /* Button Styles */
    .mode-button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin: 10px 0;
        width: 100%;
    }

    .mode-button.outer {
        background: linear-gradient(145deg, #2ecc71, #27ae60);
        color: white;
    }

    .mode-button.inner {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        color: white;
    }

    .mode-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .mode-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #3498db;
        color: white;
        font-weight: 500;
        margin: 5px;
    }

    button:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    /* Coordinate List Styles */
    #coordList {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        height: 475px;
        overflow-y: auto;
    }

    #coordList p {
        margin: 8px 0;
    }

    .coord-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    /* Download Section Styles */
    .download-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .download-section input[type="text"] {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .download-section input[type="text"]:focus {
        border-color: #3498db;
        outline: none;
    }

    /* Instructions Section Styles */
    .instructions {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .instructions h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    .instruction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }

    .instruction-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .instruction-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .section-icon {
        font-size: 24px;
        margin-right: 12px;
    }

    .instructions h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 20px;
        font-weight: 500;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        margin-bottom: 15px;
        padding-left: 0;
    }

    .feature-title {
        display: block;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .feature-desc {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .note {
        background: rgba(255, 237, 179, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .note-icon {
        color: #f39c12;
        font-size: 16px;
    }

    .note span:last-child {
        color: #666;
        font-size: 0.9em;
        flex: 1;
    }

    /* Azure Maps controls styling (from original Azure version) */
    .atlas-control-container {
        bottom: 10px !important;
        right: 10px !important;
        opacity: 0.35 !important;
        transition: opacity 0.3s;
    }

    .atlas-control-container:hover {
        opacity: 0.8 !important;
    }
</style>
</head>

<body onload="initializeMap()">

    <!-- Website header -->
    <header class="site-header">
        <h1>Geofence Creator (Azure Maps)</h1>
    </header>

    <!-- Main content container -->
    <div class="main-container">
        <!-- Map container -->
        <div class="map-container">
            <div id="myMap"></div>
        </div>

        <!-- Coordinates container -->
        <div class="coordinates-container">
            <h2>List of coordinates</h2>

            <!-- Coordinate list -->
            <div id="coordList"></div>

            <!-- Control buttons -->
            <div class="control-buttons">
                <button onclick="clearCoords()">Clear All</button>
                <button onclick="showHide()">Show/Hide Pins</button>
                <button id="modeToggleBtn" class="mode-button outer" onclick="inOut()">Currently: Outer Polygon Mode</button>
            </div>
        </div>
    </div>

    <!-- Download section -->
    <div class="download-section">
        <button onclick="download_csv_file()">Download CSV File</button>
        <input type="text" placeholder="coordinates" id="filename">.csv
    </div>

    <!-- Instructions section -->
    <div class="instructions">
        <h2>Instructions</h2>
        <div class="instruction-grid">
            <!-- Map Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üó∫Ô∏è</i>
                    <h3>Map Controls</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Navigation:</span>
                        <span class="feature-desc">Hold and drag to pan, scroll to zoom.</span>
                    </li>
                    <li>
                        <span class="feature-title">Drawing:</span>
                        <span class="feature-desc">Click to place points and create polygon outlines.</span>
                    </li>
                    <li>
                        <span class="feature-title">Adjusting Points:</span>
                        <span class="feature-desc">Drag pins to adjust positions or delete and re-add.</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Coordinate accuracy may vary depending on zoom level and imagery.</span>
                    </li>
                </ul>
            </div>

            <!-- Coordinates Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìç</i>
                    <h3>Coordinate Management</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Display:</span>
                        <span class="feature-desc">View numbered points with latitude/longitude coordinates.</span>
                    </li>
                    <li>
                        <span class="feature-title">Controls:</span>
                        <span class="feature-desc">Delete individual points, clear all, or toggle pin visibility.</span>
                    </li>
                    <li>
                        <span class="feature-title">Boundaries:</span>
                        <span class="feature-desc">Switch between inner and outer polygon creation using the mode toggle.</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Create the outer boundary first, then switch to inner polygon mode to add holes.</span>
                    </li>
                </ul>
            </div>

            <!-- CSV Export Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìä</i>
                    <h3>Data Export</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">File Format:</span>
                        <span class="feature-desc">CSV containing latitude and longitude pairs for outer and inner polygons.</span>
                    </li>
                    <li>
                        <span class="feature-title">Naming:</span>
                        <span class="feature-desc">Custom filename supported. Defaults to <i>coordinates.csv</i>.</span>
                    </li>
                    <li>
                        <span class="feature-title">Structure:</span>
                        <span class="feature-desc">CSV includes two sections:<br><b>OUTER</b> followed by exterior coordinates,<br><b>INNER</b> followed by interior (hole) coordinates.</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>CSV works with Excel, Google Sheets, and most GIS platforms.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

<script>
/* ====== Azure Maps Geofence Logic (Outer + Inner, Draggable Pins) ====== */

let map;
let datasource;
let pinsLayer;
let polygonLayer;

let outCoordinates = []; // [{lat, lon}]
let inCoordinates = [];  // [{lat, lon}]

let inside = false;      // false = outer, true = inner
let showPins = true;

// drag state
let isDragging = false;
let dragRing = null;     // 'outer' or 'inner'
let dragIndex = -1;

// Initialize Azure Map
function initializeMap() {
    map = new atlas.Map('myMap', {
        center: [-86.914, 40.425], // Example center: Purdue
        zoom: 16,
        view: 'Auto',
        authOptions: {
            authType: 'subscriptionKey',
            subscriptionKey: "YOUR_AZURE_MAPS_KEY_HERE"
        }
    });

    map.events.add('ready', () => {
        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        // Polygon layer (outer with hole)
        polygonLayer = new atlas.layer.PolygonLayer(datasource, null, {
            fillColor: 'rgba(46, 204, 113, 0.3)',
            strokeColor: '#27ae60',
            strokeWidth: 2
        });

        // Pins layer (for both outer + inner)
        pinsLayer = new atlas.layer.SymbolLayer(datasource, null, {
            filter: ['==', ['geometry-type'], 'Point'],
            iconOptions: {
                image: 'pin-round-darkblue',
                allowOverlap: true,
                anchor: 'bottom'
            },
            textOptions: {
                textField: ['get', 'label'],
                offset: [0, -1.2],
                size: 12,
                color: 'white',
                haloColor: 'black',
                haloWidth: 1
            }
        });

        map.layers.add([polygonLayer, pinsLayer]);

        // Map click to add points
        map.events.add('click', onMapClick);

        // Dragging pins: use mouse events on the symbol layer
        map.events.add('mousedown', pinsLayer, onPinMouseDown);
        map.events.add('touchstart', pinsLayer, onPinMouseDown);

        map.events.add('mouseup', onPointerUp);
        map.events.add('touchend', onPointerUp);
        map.events.add('mousemove', onPointerMove);
        map.events.add('touchmove', onPointerMove);

        // Hide Accessibility Help popups (like original Azure version)
        const hideAccessibilityHelp = () => {
            document.querySelectorAll('.atlas-map-accessibility-help').forEach(el => {
                el.style.display = 'none';
            });
        };
        hideAccessibilityHelp();
        const observer = new MutationObserver(hideAccessibilityHelp);
        observer.observe(document.body, { childList: true, subtree: true });

        // Initial empty UI
        listUpdate();
    });
}

// When user clicks on the map (adds a point)
function onMapClick(e) {
    if (isDragging) return; // Don't add new points while dragging

    if (!e.position) return;
    const [lon, lat] = e.position;

    if (!inside) {
        outCoordinates.push({ lat, lon });
    } else {
        inCoordinates.push({ lat, lon });
    }

    draw();
}

// Called when user presses down on a pin (start drag)
function onPinMouseDown(e) {
    if (!e.shapes || e.shapes.length === 0) return;

    const shape = e.shapes[0];
    const props = shape.getProperties();

    if (props && typeof props.index === 'number' && props.ring) {
        isDragging = true;
        dragRing = props.ring;   // 'outer' or 'inner'
        dragIndex = props.index; // index in the appropriate array
        e.preventDefault();
    }
}

// Called when user moves pointer (drag in progress)
function onPointerMove(e) {
    if (!isDragging) return;
    if (!e.position) return;

    const [lon, lat] = e.position;

    if (dragRing === 'outer' && outCoordinates[dragIndex]) {
        outCoordinates[dragIndex] = { lat, lon };
    } else if (dragRing === 'inner' && inCoordinates[dragIndex]) {
        inCoordinates[dragIndex] = { lat, lon };
    }

    draw();
}

// Called when user releases pointer (end drag)
function onPointerUp(e) {
    if (!isDragging) return;
    isDragging = false;
    dragRing = null;
    dragIndex = -1;
}

// Redraw pins and polygon on map
function draw() {
    datasource.clear();

    const features = [];

    // Outer pins
    outCoordinates.forEach((c, i) => {
        features.push(new atlas.data.Feature(
            new atlas.data.Point([c.lon, c.lat]),
            {
                ring: 'outer',
                index: i,
                label: String(i + 1)
            }
        ));
    });

    // Inner pins
    inCoordinates.forEach((c, i) => {
        features.push(new atlas.data.Feature(
            new atlas.data.Point([c.lon, c.lat]),
            {
                ring: 'inner',
                index: i,
                label: String(i + 1)
            }
        ));
    });

    // Build polygon with outer + optional inner ring
    if (outCoordinates.length >= 3) {
        const outerRing = outCoordinates.map(c => [c.lon, c.lat]);
        outerRing.push(outerRing[0]); // close

        const rings = [outerRing];

        if (inCoordinates.length >= 3) {
            const innerRing = inCoordinates.map(c => [c.lon, c.lat]);
            innerRing.push(innerRing[0]);
            rings.push(innerRing);
        }

        const poly = new atlas.data.Polygon(rings);
        features.push(new atlas.data.Feature(poly));
    }

    datasource.add(features);

    // Toggle pins visibility
    pinsLayer.setOptions({ visible: showPins });

    listUpdate();
}

// Clear all points and shapes
function clearCoords() {
    outCoordinates = [];
    inCoordinates = [];
    datasource && datasource.clear();
    listUpdate();
}

// Show/hide pins
function showHide() {
    showPins = !showPins;
    if (pinsLayer) {
        pinsLayer.setOptions({ visible: showPins });
    }
}

// Toggle outer/inner editing mode
function inOut() {
    const toggleBtn = document.getElementById("modeToggleBtn");

    inside = !inside;

    if (!inside) {
        toggleBtn.innerHTML = "Currently: Outer Polygon Mode";
        toggleBtn.className = "mode-button outer";
    } else {
        toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
        toggleBtn.className = "mode-button inner";
    }
}

// Delete an outer coordinate
function deleteOuterCoord(index) {
    // index is 1-based from the UI
    outCoordinates.splice(index - 1, 1);
    draw();
}

// Delete an inner coordinate
function deleteInnerCoord(index) {
    inCoordinates.splice(index - 1, 1);
    draw();
}

// Update the visible coordinate list in the sidebar
function listUpdate() {
    const element = document.getElementById("coordList");
    if (!element) return;

    element.innerHTML = "";

    // Exterior header
    let p = document.createElement("p");
    p.textContent = "Exterior Coordinates:";
    element.appendChild(p);

    let n = 0;
    outCoordinates.forEach((c) => {
        n += 1;

        const wrapper = document.createElement("p");
        wrapper.style.display = "inline";

        const text = document.createTextNode(
            n + ". (" + c.lat.toFixed(6) + ", " + c.lon.toFixed(6) + ")   "
        );
        wrapper.appendChild(text);

        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";
        deleteButton.addEventListener("click", () => deleteOuterCoord(n));

        element.appendChild(wrapper);
        element.appendChild(deleteButton);
        element.appendChild(document.createElement("br"));
    });

    // Inner header
    element.appendChild(document.createElement("br"));
    let p2 = document.createElement("p");
    p2.textContent = "Inner Coordinates:";
    element.appendChild(p2);

    n = 0;
    inCoordinates.forEach((c) => {
        n += 1;

        const wrapper = document.createElement("p");
        wrapper.style.display = "inline";

        const text = document.createTextNode(
            n + ". (" + c.lat.toFixed(6) + ", " + c.lon.toFixed(6) + ")   "
        );
        wrapper.appendChild(text);

        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";
        deleteButton.addEventListener("click", () => deleteInnerCoord(n));

        element.appendChild(wrapper);
        element.appendChild(deleteButton);
        element.appendChild(document.createElement("br"));
    });
}

// Download OUTER + INNER CSV like original
function download_csv_file() {
    let CSV = "";

    CSV += "OUTER\n";
    outCoordinates.forEach(c => {
        CSV += c.lat + "," + c.lon + "\n";
    });

    CSV += "INNER\n";
    inCoordinates.forEach(c => {
        CSV += c.lat + "," + c.lon + "\n";
    });

    if (CSV.trim() === "OUTER\nINNER") {
        alert("No coordinates to download!");
        return;
    }

    const coordFile = document.createElement('a');
    coordFile.href = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);
    coordFile.target = '_blank';

    let inputName = document.getElementById("filename").value;
    if (!inputName) inputName = "coordinates";

    coordFile.download = inputName + '.csv';
    coordFile.click();
}
</script>

</body>
</html>
