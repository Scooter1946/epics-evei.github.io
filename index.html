<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>Geofence Creator (Leaflet + OpenStreetMap)</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
    /* Global Styles */
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f7fa;
        color: #2c3e50;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header Styles */
    .site-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #2980b9 100%);
        position: relative;
        color: white;
        padding: 40px 20px;
        margin: -20px -20px 20px -20px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .site-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            45deg,
            rgba(255,255,255,0.03) 0px,
            rgba(255,255,255,0.03) 1px,
            transparent 1px,
            transparent 4px
        );
        pointer-events: none;
    }

    .site-header h1 {
        margin: 0;
        font-size: 3.2em;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
        position: relative;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .site-header h1::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: rgba(255,255,255,0.5);
        border-radius: 2px;
    }

    /* Container Styles */
    .main-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .map-container {
        flex: 1;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .coordinates-container {
        width: 500px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }

    #myMap {
        width: 100%;
        height: 600px;
    }

    /* Button Styles */
    .mode-button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin: 10px 0;
        width: 100%;
    }

    .mode-button.outer {
        background: linear-gradient(145deg, #2ecc71, #27ae60);
        color: white;
    }

    .mode-button.inner {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        color: white;
    }

    .mode-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .mode-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #3498db;
        color: white;
        font-weight: 500;
        margin: 5px;
    }

    button:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    /* Coordinate List Styles */
    #coordList {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        height: 475px;
        overflow-y: auto;
    }

    #coordList p {
        margin: 8px 0;
    }

    .coord-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    /* Download Section Styles */
    .download-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .download-section input[type="text"] {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .download-section input[type="text"]:focus {
        border-color: #3498db;
        outline: none;
    }

    /* Instructions Section Styles */
    .instructions {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .instructions h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    .instruction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }

    .instruction-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .instruction-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .section-icon {
        font-size: 24px;
        margin-right: 12px;
    }

    .instructions h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 20px;
        font-weight: 500;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        margin-bottom: 15px;
        padding-left: 0;
    }

    .feature-title {
        display: block;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .feature-desc {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .note {
        background: rgba(255, 237, 179, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .note-icon {
        color: #f39c12;
        font-size: 16px;
    }

    .note span:last-child {
        color: #666;
        font-size: 0.9em;
        flex: 1;
    }

    /* ===== Enhanced Quick Instructions Bar ===== */
.quick-instructions {
    background: #e3effd;
    border-left: 6px solid #3498db;
    border-radius: 8px;
    padding: 14px 18px;
    font-size: 15px;
    color: #2c3e50;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Subtle icon before text */
.quick-instructions::before {
    content: "‚ÑπÔ∏è";
    font-size: 18px;
    margin-right: 6px;
}

/* Enhanced Button */
.jump-instructions {
    padding: 8px 18px;
    font-size: 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(145deg, #3498db, #2d87c7);
    color: white;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease;
}

.jump-instructions:hover {
    background: linear-gradient(145deg, #2d87c7, #2473ad);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

.jump-instructions:active {
    transform: translateY(0px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

</style>
</head>

<body onload="initializeMap()">

    <!-- Website header -->
    <header class="site-header">
        <h1>Geofence Creator (Leaflet + OpenStreetMap)</h1>
    </header>

    <!-- Quick Instructions Bar -->
    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
        <div class="quick-instructions">
            <strong>Quick Instructions:</strong>
            Click to add points ‚Ä¢ Toggle modes for outer/inner ‚Ä¢ Drag pins to adjust
        </div>
        <button class="jump-instructions" onclick="scrollToInstructions()">Full Instructions</button>
    </div>

    <!-- Main content container -->
    <div class="main-container">
        <!-- Map container -->
        <div class="map-container">
            <div id="myMap"></div>
        </div>

        <!-- Coordinates container -->
        <div class="coordinates-container">
            <h2>List of coordinates</h2>

            <!-- Coordinate list -->
            <div id="coordList"></div>

            <!-- Control buttons -->
            <div class="control-buttons">
                <button onclick="clearCoords()">Clear All</button>
                <button onclick="showHide()">Show/Hide Pins</button>
                <button id="modeToggleBtn" class="mode-button outer" onclick="inOut()">
                    Currently: Outer Polygon Mode
                </button>
                <button onclick="startNewInnerRing()">Start New Inner Polygon</button>
            </div>
        </div>
    </div>

    <!-- Download section -->
    <div class="download-section">
        <button onclick="download_csv_file()">Download CSV File</button>
        <input type="text" placeholder="coordinates" id="filename">.csv
    </div>

    <!-- Instructions section -->
<<<<<<< HEAD
    <div class="instruction-grid">

        <!-- Map Controls -->
        <div class="instruction-section">
            <div class="section-header">
                <i class="section-icon">üó∫Ô∏è</i>
                <h3>Map Controls</h3>
            </div>
            <ul class="feature-list">
    
                <li>
                    <span class="feature-title">Navigation:</span>
                    <span class="feature-desc">
                        ‚Ä¢ Click and drag to pan the map.  
                        ‚Ä¢ Scroll to zoom in or out for finer precision.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Drawing the Geofence Boundaries:</span>
                    <span class="feature-desc">
                        ‚Ä¢ Click anywhere on the map to <b>place a coordinate point</b>.  
                        ‚Ä¢ When multiple points are placed, they connect in order to form the boundary.  
                        ‚Ä¢ Drag markers to reposition points.  
                        ‚Ä¢ Remove points using the delete button in the Coordinate Panel.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Tip #1:</span>
                    <span class="feature-desc">
                        Zoom in to place more precise coordinates.
                    </span>
                </li>
    
            </ul>
        </div>
    
        <!-- Coordinate Panel -->
=======
    <div class="instructions">
    <h2>Instructions</h2>

    <div class="instruction-grid">

        <!-- MAP CONTROLS BOX -->
        <div class="instruction-section">
            <div class="section-header">
                <i class="section-icon">üó∫Ô∏è</i>
                <h3>Map Controls</h3>
            </div>

            <ul class="feature-list">

                <li>
                    <span class="feature-title"><strong>Navigation:</strong></span>
                    <span class="feature-desc">
                        Click and drag to pan the map; scroll to zoom.
                    </span>
                </li>

                <li>
                    <span class="feature-title"><strong>Drawing the Geofence Boundaries:</strong></span>
                    <span class="feature-desc">
                        Click on the map to place a <strong>coordinate point</strong>.  
                        When multiple points are dropped, they connect in the order added to form a closed boundary.  
                        Points can be repositioned by <strong>clicking</strong> and <strong>dragging</strong> them on the map.  
                        <strong>Delete</strong> points in the <strong>Coordinate Panel</strong> using the delete button next to each point.
                    </span>
                </li>

                <li class="note">
                    <span class="note-icon">üìù</span>
                    <span><strong>Tip #1:</strong> Zoom in to place more precise coordinate points.</span>
                </li>
            </ul>
        </div>

        <!-- COORDINATE PANEL BOX -->
>>>>>>> e6b4a86aa5cd485fe4e3b4837dc2a536a9cb35dd
        <div class="instruction-section">
            <div class="section-header">
                <i class="section-icon">üìç</i>
                <h3>Coordinate Panel</h3>
            </div>
<<<<<<< HEAD
            <ul class="feature-list">
    
                <li>
                    <span class="feature-title">Information Shown:</span>
                    <span class="feature-desc">
                        ‚Ä¢ A list of coordinate points for the outer boundary appears first.  
                        ‚Ä¢ Inner boundary coordinates (holes) follow.  
                        ‚Ä¢ Latitude and longitude values are shown for each point.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Controls:</span>
                    <span class="feature-desc">
                        ‚Ä¢ Delete individual points or click <b>Clear All</b> to reset everything.  
                        ‚Ä¢ Use <b>Show/Hide Pins</b> to toggle marker visibility without removing the geofence.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Input Modes:</span>
                    <span class="feature-desc">
                        ‚Ä¢ <b>Outer boundary mode:</b> Points connect to form the main boundary where the kart is allowed.  
                        ‚Ä¢ <b>Inner boundary mode:</b> Points form a hole (restricted area) inside the outer boundary.  
                        ‚Ä¢ Click <b>Start New Inner Boundary</b> to create multiple holes.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Tip #2:</span>
                    <span class="feature-desc">
                        Complete the entire outer boundary first, then add any inner boundaries.
                    </span>
                </li>
    
            </ul>
        </div>
    
        <!-- Data Export -->
=======

            <ul class="feature-list">

                <li>
                    <span class="feature-title"><strong>Information Shown:</strong></span>
                    <span class="feature-desc">
                        A <strong>list of coordinate points</strong> for the outer boundary appears first,  
                        followed by a list of points for any inner boundaries.  
                        Latitude and longitude values are displayed to the right of each point.
                    </span>
                </li>

                <li>
                    <span class="feature-title"><strong>Controls:</strong></span>
                    <span class="feature-desc">
                        You can delete individual coordinate points or click <strong>Clear All</strong> to restart entirely.  
                        Toggling <strong>Show/Hide Pins</strong> will show or hide point markers without hiding the geofence boundary itself.
                    </span>
                </li>

                <li>
                    <span class="feature-title"><strong>Input Modes:</strong></span>
                    <span class="feature-desc">
                        <strong>Outer boundary mode:</strong> Points connect to form an outer boundary,  
                        which restricts where the kart can travel. Only one outer boundary can be created.  
                        <br><br>
                        <strong>Inner boundary mode:</strong> Coordinate points connect to form a hole (inner boundary)  
                        inside the outer boundary where the kart cannot go.  
                        Clicking <strong>Start New Inner Boundary</strong> allows you to create multiple holes.
                    </span>
                </li>

                <li class="note">
                    <span class="note-icon">üìù</span>
                    <span><strong>Tip #2:</strong> Create the entire outer boundary first, then define one or more inner boundaries if needed.</span>
                </li>

            </ul>
        </div>

        <!-- DATA EXPORT BOX -->
>>>>>>> e6b4a86aa5cd485fe4e3b4837dc2a536a9cb35dd
        <div class="instruction-section">
            <div class="section-header">
                <i class="section-icon">üìä</i>
                <h3>Data Export</h3>
            </div>
<<<<<<< HEAD
            <ul class="feature-list">
    
                <li>
                    <span class="feature-title">File Format:</span>
                    <span class="feature-desc">
                        Click <b>Download CSV File</b> to save a CSV containing your geofence coordinates.  
                        The file is named <i>coordinates.csv</i> by default unless you provide a custom name.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Structure:</span>
                    <span class="feature-desc">
                        ‚Ä¢ Outer boundary coordinates are grouped under <b>OUTER</b>.  
                        ‚Ä¢ Inner boundary coordinates are grouped under <b>INNER</b>.  
                        ‚Ä¢ Each coordinate is saved as <code>lat,lon</code>.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Tip #3:</span>
                    <span class="feature-desc">
                        CSV files open cleanly in Excel, Google Sheets, and most data tools.
                    </span>
                </li>
    
                <li>
                    <span class="feature-title">Tip #4:</span>
                    <span class="feature-desc">
                        Use the default filename unless working with multiple geofence versions.
                    </span>
                </li>
    
            </ul>
        </div>
    
    </div>
    
=======

            <ul class="feature-list">

                <li>
                    <span class="feature-title"><strong>File Format:</strong></span>
                    <span class="feature-desc">
                        Click <strong>Download CSV File</strong> to save a comma-separated values file  
                        containing your geofence bounds.  
                        This file is named <strong>coordinates.csv</strong> by default.
                    </span>
                </li>

                <li>
                    <span class="feature-title"><strong>Structure:</strong></span>
                    <span class="feature-desc">
                        Inside the file, outer coordinates are grouped under <strong>OUTER</strong>,  
                        and inner boundary coordinates under <strong>INNER</strong>.  
                        Each coordinate is stored as a latitude‚Äìlongitude pair (<strong>lat, lon</strong>).
                    </span>
                </li>

                <li class="note">
                    <span class="note-icon">üìù</span>
                    <span><strong>Tip #3:</strong> CSV files can be opened cleanly in <strong>Excel</strong>, <strong>Google Sheets</strong>, and most data management software.</span>
                </li>

                <li class="note">
                    <span class="note-icon">üìù</span>
                    <span><strong>Tip #4:</strong> For compatibility, use the default file name (<strong>coordinates.csv</strong>).</span>
                </li>

            </ul>
        </div>

    </div>
</div>

>>>>>>> e6b4a86aa5cd485fe4e3b4837dc2a536a9cb35dd

<script>
/* ====== Leaflet Geofence Logic (Outer + Multiple Inner Holes) ====== */

// Map + layers
let map;
let geofenceLayer;

// Data: outer polygon and multiple inner rings
let outerCoords = [];      // [{lat, lng}]
let innerRings = [];       // [ [{lat, lng}], [{lat, lng}], ... ]

// Marker references
let outerMarkers = [];     // [L.marker, ...]
let innerMarkers = [];     // [ [L.marker, ...], [L.marker, ...], ... ]

// State
let inside = false;        // false = outer mode, true = inner mode
let currentInnerRing = -1; // index in innerRings when in inner mode
let showPins = true;

// Layers for shapes
let polygonLayer = null;
let previewLine = null;


// Initialize Leaflet map
function initializeMap() {
    map = L.map('myMap').setView([40.425, -86.914], 16); // Purdue-ish

    // OpenStreetMap tiles (free, no key)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    geofenceLayer = L.layerGroup().addTo(map);

    // Map click to add points
    map.on('click', onMapClick);

    listUpdate();
}

// Handle map click: add point to outer or inner geometry
function onMapClick(e) {
    const latlng = e.latlng;
    if (!latlng) return;

    if (!inside) {
        // OUTER mode
        outerCoords.push({ lat: latlng.lat, lng: latlng.lng });
    } else {
        // INNER mode: ensure we have a current ring
        if (currentInnerRing === -1 || !innerRings[currentInnerRing]) {
            innerRings.push([]);
            innerMarkers.push([]);
            currentInnerRing = innerRings.length - 1;
        }
        innerRings[currentInnerRing].push({ lat: latlng.lat, lng: latlng.lng });
    }

    draw();
}

// Create a new inner polygon ring
function startNewInnerRing() {
    inside = true;
    const toggleBtn = document.getElementById("modeToggleBtn");
    toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
    toggleBtn.className = "mode-button inner";

    innerRings.push([]);
    innerMarkers.push([]);
    currentInnerRing = innerRings.length - 1;
    listUpdate();
}

// Rebuild markers (full redraw) and then shapes
function draw() {
    // Clear shape layers
    geofenceLayer.clearLayers();
    polygonLayer = null;
    previewLine = null;

    outerMarkers = [];
    innerMarkers = innerRings.map(() => []);

    // ===== OUTER MARKERS =====
    outerCoords.forEach((c, i) => {
        const marker = L.marker([c.lat, c.lng], {
            draggable: true,
            icon: L.divIcon({
                className: 'outer-marker-icon',
                html: `
                    <div style="background:#27ae60;border-radius:50%;width:16px;height:16px;
                                border:2px solid white;box-shadow:0 0 2px rgba(0,0,0,0.5);"></div>
                    <span style="position:absolute;font-size:11px;font-weight:600;color:#2c3e50;
                                top:-18px;left:-5px;">O${i + 1}</span>
                `,
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            })
        });
        marker._ringType = 'outer';
        marker._ringIndex = 0;
        marker._pointIndex = i;

        marker.on("drag", (e) => {
            const m = e.target;
            const pos = m.getLatLng();
            outerCoords[m._pointIndex] = { lat: pos.lat, lng: pos.lng };
            updateShapes();
        });

        outerMarkers.push(marker);
        if (showPins) geofenceLayer.addLayer(marker);
    });

    // ===== INNER MARKERS =====
    innerRings.forEach((ring, rIndex) => {
        ring.forEach((c, i) => {
            const marker = L.marker([c.lat, c.lng], {
                draggable: true,
                icon: L.divIcon({
                    className: 'inner-marker-icon',
                    html: `
                        <div style="background:#e74c3c;border-radius:50%;width:14px;height:14px;
                                    border:2px solid white;box-shadow:0 0 2px rgba(0,0,0,0.5);"></div>
                        <span style="position:absolute;font-size:10px;font-weight:600;color:#c0392b;
                                    top:-16px;left:-8px;">H${rIndex + 1}-${i + 1}</span>
                    `,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            });

            marker._ringType = 'inner';
            marker._ringIndex = rIndex;
            marker._pointIndex = i;

            marker.on("drag", (e) => {
                const m = e.target;
                const pos = m.getLatLng();
                innerRings[m._ringIndex][m._pointIndex] = { lat: pos.lat, lng: pos.lng };
                updateShapes();
            });

            innerMarkers[rIndex].push(marker);
            if (showPins) geofenceLayer.addLayer(marker);
        });
    });

    updateShapes();
    listUpdate();
}

// Update polygon (filled + holes) and preview line live
function updateShapes() {
    // --- Polygon with holes ---
    if (outerCoords.length >= 3) {
        const outerLatLngs = outerCoords.map(c => [c.lat, c.lng]);
        const holes = innerRings
            .filter(ring => ring.length >= 3)
            .map(ring => ring.map(c => [c.lat, c.lng]));

        const latlngs = [outerLatLngs, ...holes];

        if (polygonLayer) {
            polygonLayer.setLatLngs(latlngs);
        } else {
            polygonLayer = L.polygon(latlngs, {
                color: '#27ae60',
                weight: 2,
                fillColor: 'rgba(46, 204, 113, 0.3)',
                fillOpacity: 0.3,
                interactive: false
            });
            geofenceLayer.addLayer(polygonLayer);
        }
    } else {
        if (polygonLayer) {
            geofenceLayer.removeLayer(polygonLayer);
            polygonLayer = null;
        }
    }

    // --- Preview line (Option B: outer or current inner ring) ---
    let coords = null;

    if (inside && currentInnerRing !== -1 && innerRings[currentInnerRing] && innerRings[currentInnerRing].length > 1) {
        coords = innerRings[currentInnerRing].map(c => [c.lat, c.lng]);
    } else if (outerCoords.length > 1) {
        coords = outerCoords.map(c => [c.lat, c.lng]);
    }

    if (coords) {
        if (previewLine) {
            previewLine.setLatLngs(coords);
        } else {
            previewLine = L.polyline(coords, {
                color: '#34495e',
                weight: 2,
                dashArray: '6, 6',
                opacity: 0.7
            });
            geofenceLayer.addLayer(previewLine);
        }
    } else {
        if (previewLine) {
            geofenceLayer.removeLayer(previewLine);
            previewLine = null;
        }
    }
}

// Clear all geometry
function clearCoords() {
    outerCoords = [];
    innerRings = [];
    outerMarkers = [];
    innerMarkers = [];
    currentInnerRing = -1;

    if (geofenceLayer) geofenceLayer.clearLayers();
    polygonLayer = null;
    previewLine = null;

    listUpdate();
}

// Show/hide pins
function showHide() {
    showPins = !showPins;
    draw();
}

// Toggle between outer and inner edit mode
function inOut() {
    const toggleBtn = document.getElementById("modeToggleBtn");

    inside = !inside;

    if (!inside) {
        toggleBtn.innerHTML = "Currently: Outer Polygon Mode";
        toggleBtn.className = "mode-button outer";
        currentInnerRing = -1; // not editing any specific inner ring
    } else {
        toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
        toggleBtn.className = "mode-button inner";

        // If no inner rings exist yet, create the first one
        if (innerRings.length === 0) {
            innerRings.push([]);
            innerMarkers.push([]);
        }
        if (currentInnerRing === -1) {
            currentInnerRing = 0;
        }
    }
    updateShapes();
    listUpdate();
}

// Delete outer coordinate by 1-based index
function deleteOuterCoord(index) {
    outerCoords.splice(index - 1, 1);
    draw();
}

// Delete inner coordinate by ring + 1-based index
function deleteInnerCoord(ringIndex, pointIndex) {
    if (!innerRings[ringIndex]) return;
    innerRings[ringIndex].splice(pointIndex - 1, 1);

    // If ring becomes empty, remove it
    if (innerRings[ringIndex].length === 0) {
        innerRings.splice(ringIndex, 1);
    }
    draw();
}

// Update the visible coordinate list
function listUpdate() {
    const element = document.getElementById("coordList");
    if (!element) return;

    element.innerHTML = "";

    // Exterior coordinates
    let p = document.createElement("p");
    p.textContent = "Exterior Coordinates:";
    element.appendChild(p);

    outerCoords.forEach((c, idx) => {
        const wrapper = document.createElement("p");
        wrapper.style.display = "inline";

        wrapper.appendChild(
            document.createTextNode(
                (idx + 1) + ". (" + c.lat.toFixed(6) + ", " + c.lng.toFixed(6) + ")   "
            )
        );

        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";

        const deleteIndex = idx + 1; // correct index
        deleteButton.addEventListener("click", () => deleteOuterCoord(deleteIndex));

        element.appendChild(wrapper);
        element.appendChild(deleteButton);
        element.appendChild(document.createElement("br"));
    });

    element.appendChild(document.createElement("br"));

    // Inner rings
    let p2 = document.createElement("p");
    p2.textContent = "Inner Coordinates (holes):";
    element.appendChild(p2);

    if (innerRings.length === 0) {
        const none = document.createElement("p");
        none.textContent = "No inner polygons yet.";
        element.appendChild(none);
        return;
    }

    innerRings.forEach((ring, rIndex) => {
        const ringHeader = document.createElement("p");
        ringHeader.style.fontWeight = "600";
        ringHeader.textContent = "Inner Polygon " + (rIndex + 1) + ":";
        element.appendChild(ringHeader);

        ring.forEach((c, idx) => {
            const wrapper = document.createElement("p");
            wrapper.style.display = "inline";

            wrapper.appendChild(
                document.createTextNode(
                    (idx + 1) + ". (" + c.lat.toFixed(6) + ", " + c.lng.toFixed(6) + ")   "
                )
            );

            const deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete";

            const ringNum = rIndex;
            const pointNum = idx + 1;

            deleteButton.addEventListener("click", () =>
                deleteInnerCoord(ringNum, pointNum)
            );

            element.appendChild(wrapper);
            element.appendChild(deleteButton);
            element.appendChild(document.createElement("br"));
        });

        element.appendChild(document.createElement("br"));
    });
}


// Download CSV with OUTER and INNER sections
function download_csv_file() {
    let CSV = "";

    CSV += "OUTER\n";
    outerCoords.forEach(c => {
        CSV += c.lat + "," + c.lng + "\n";
    });

    CSV += "INNER\n";
    innerRings.forEach(ring => {
        ring.forEach(c => {
            CSV += c.lat + "," + c.lng + "\n";
        });
    });

    if (CSV.trim() === "OUTER\nINNER") {
        alert("No coordinates to download!");
        return;
    }

    const coordFile = document.createElement('a');
    coordFile.href = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);
    coordFile.target = '_blank';

    let inputName = document.getElementById("filename").value;
    if (!inputName) inputName = "coordinates";

    coordFile.download = inputName + '.csv';
    coordFile.click();
}

// ===== Scroll to Full Instructions Section =====
function scrollToInstructions() {
    document.querySelector(".instructions").scrollIntoView({ behavior: "smooth" });
}

</script>

</body>
</html>