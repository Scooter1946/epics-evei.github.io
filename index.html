<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>Geofence Creator (Leaflet + OpenStreetMap)</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
    /* Global Styles */
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f7fa;
        color: #2c3e50;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header Styles */
    .site-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #2980b9 100%);
        position: relative;
        color: white;
        padding: 40px 20px;
        margin: -20px -20px 20px -20px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .site-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            45deg,
            rgba(255,255,255,0.03) 0px,
            rgba(255,255,255,0.03) 1px,
            transparent 1px,
            transparent 4px
        );
        pointer-events: none;
    }

    .site-header h1 {
        margin: 0;
        font-size: 3.2em;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
        position: relative;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .site-header h1::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: rgba(255,255,255,0.5);
        border-radius: 2px;
    }

    /* Container Styles */
    .main-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .map-container {
        flex: 1;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .coordinates-container {
        width: 500px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }

    #myMap {
        width: 100%;
        height: 600px;
    }

    /* Button Styles */
    .mode-button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin: 10px 0;
        width: 100%;
    }

    .mode-button.outer {
        background: linear-gradient(145deg, #2ecc71, #27ae60);
        color: white;
    }

    .mode-button.inner {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        color: white;
    }

    .mode-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .mode-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #3498db;
        color: white;
        font-weight: 500;
        margin: 5px;
    }

    button:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    /* Coordinate List Styles */
    #coordList {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        height: 475px;
        overflow-y: auto;
    }

    #coordList p {
        margin: 8px 0;
    }

    .coord-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    /* Download Section Styles */
    .download-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .download-section input[type="text"] {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .download-section input[type="text"]:focus {
        border-color: #3498db;
        outline: none;
    }

    /* Instructions Section Styles */
    .instructions {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .instructions h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    .instruction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }

    .instruction-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .instruction-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .section-icon {
        font-size: 24px;
        margin-right: 12px;
    }

    .instructions h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 20px;
        font-weight: 500;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feature-list li {
        margin-bottom: 15px;
        padding-left: 0;
    }

    .feature-title {
        display: block;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .feature-desc {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .note {
        background: rgba(255, 237, 179, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .note-icon {
        color: #f39c12;
        font-size: 16px;
    }

    .note span:last-child {
        color: #666;
        font-size: 0.9em;
        flex: 1;
    }
</style>
</head>

<body onload="initializeMap()">

    <!-- Website header -->
    <header class="site-header">
        <h1>Geofence Creator (Leaflet + OpenStreetMap)</h1>
    </header>

    <!-- Main content container -->
    <div class="main-container">
        <!-- Map container -->
        <div class="map-container">
            <div id="myMap"></div>
        </div>

        <!-- Coordinates container -->
        <div class="coordinates-container">
            <h2>List of coordinates</h2>

            <!-- Coordinate list -->
            <div id="coordList"></div>

            <!-- Control buttons -->
            <div class="control-buttons">
                <button onclick="clearCoords()">Clear All</button>
                <button onclick="showHide()">Show/Hide Pins</button>
                <button id="modeToggleBtn" class="mode-button outer" onclick="inOut()">
                    Currently: Outer Polygon Mode
                </button>
                <button onclick="startNewInnerRing()">Start New Inner Polygon</button>
            </div>
        </div>
    </div>

    <!-- Download section -->
    <div class="download-section">
        <button onclick="download_csv_file()">Download CSV File</button>
        <input type="text" placeholder="coordinates" id="filename">.csv
    </div>

    <!-- Instructions section -->
    <div class="instructions">
        <h2>Instructions</h2>
        <div class="instruction-grid">
            <!-- Map Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üó∫Ô∏è</i>
                    <h3>Map Controls</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Navigation:</span>
                        <span class="feature-desc">Click and drag to pan, scroll to zoom.</span>
                    </li>
                    <li>
                        <span class="feature-title">Drawing:</span>
                        <span class="feature-desc">
                            Click on the map to drop points. Points in <b>Outer mode</b> create the exterior boundary.
                            Points in <b>Inner mode</b> create exclusion zones (holes).
                        </span>
                    </li>
                    <li>
                        <span class="feature-title">Adjusting Points:</span>
                        <span class="feature-desc">
                            Drag markers to fine-tune positions, or delete them from the coordinate list and re-add.
                        </span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Higher zoom levels give more precise coordinates.</span>
                    </li>
                </ul>
            </div>

            <!-- Coordinates Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìç</i>
                    <h3>Coordinate Management</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Display:</span>
                        <span class="feature-desc">
                            View numbered latitude/longitude pairs for the outer boundary and each inner polygon.
                        </span>
                    </li>
                    <li>
                        <span class="feature-title">Controls:</span>
                        <span class="feature-desc">
                            Delete individual points, clear all geometry, or toggle pin visibility to view just the polygons.
                        </span>
                    </li>
                    <li>
                        <span class="feature-title">Boundaries:</span>
                        <span class="feature-desc">
                            Use the mode toggle to switch between editing the outer polygon and inner polygons (holes).
                            Use <b>‚ÄúStart New Inner Polygon‚Äù</b> to create multiple inner exclusion zones.
                        </span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Create the outer boundary first, then define one or more inner polygons if needed.</span>
                    </li>
                </ul>
            </div>

            <!-- CSV Export Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìä</i>
                    <h3>Data Export</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">File Format:</span>
                        <span class="feature-desc">
                            CSV containing latitude and longitude pairs. Outer coordinates are grouped under <b>OUTER</b>,
                            inner (hole) coordinates under <b>INNER</b>.
                        </span>
                    </li>
                    <li>
                        <span class="feature-title">Naming:</span>
                        <span class="feature-desc">
                            Custom filename supported. Defaults to <i>coordinates.csv</i> if left blank.
                        </span>
                    </li>
                    <li>
                        <span class="feature-title">Structure:</span>
                        <span class="feature-desc">
                            <b>OUTER</b><br>
                            lat,lon<br>
                            ‚Ä¶<br><br>
                            <b>INNER</b><br>
                            lat,lon (for all inner polygons combined)
                        </span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>CSV opens cleanly in Excel, Google Sheets, and most GIS tools.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

<script>
/* ====== Leaflet Geofence Logic (Outer + Multiple Inner Holes) ====== */

// Map + layers
let map;
let geofenceLayer;

// Data: outer polygon and multiple inner rings
let outerCoords = [];      // [{lat, lng}]
let innerRings = [];       // [ [{lat, lng}], [{lat, lng}], ... ]

// Marker references
let outerMarkers = [];     // [L.marker, ...]
let innerMarkers = [];     // [ [L.marker, ...], [L.marker, ...], ... ]

// State
let inside = false;        // false = outer mode, true = inner mode
let currentInnerRing = -1; // index in innerRings when in inner mode
let showPins = true;

// Initialize Leaflet map
function initializeMap() {
    map = L.map('myMap').setView([40.425, -86.914], 16); // Purdue-ish

    // OpenStreetMap tiles (free, no key)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    geofenceLayer = L.layerGroup().addTo(map);

    // Map click to add points
    map.on('click', onMapClick);

    listUpdate();
}

// Handle map click: add point to outer or inner geometry
function onMapClick(e) {
    const latlng = e.latlng;
    if (!latlng) return;

    if (!inside) {
        // OUTER mode
        outerCoords.push({ lat: latlng.lat, lng: latlng.lng });
    } else {
        // INNER mode: ensure we have a current ring
        if (currentInnerRing === -1 || !innerRings[currentInnerRing]) {
            // Create first inner ring automatically
            innerRings.push([]);
            innerMarkers.push([]);
            currentInnerRing = innerRings.length - 1;
        }
        innerRings[currentInnerRing].push({ lat: latlng.lat, lng: latlng.lng });
    }

    draw();
}

// Create a new inner polygon ring
function startNewInnerRing() {
    inside = true;
    const toggleBtn = document.getElementById("modeToggleBtn");
    toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
    toggleBtn.className = "mode-button inner";

    innerRings.push([]);
    innerMarkers.push([]);
    currentInnerRing = innerRings.length - 1;
    listUpdate();
}

// Rebuild all markers + polygon(s)
function draw() {
    geofenceLayer.clearLayers();
    outerMarkers = [];
    innerMarkers = innerRings.map(() => []);

    // Build outer markers
    outerCoords.forEach((c, i) => {
        const marker = L.marker([c.lat, c.lng], {
            draggable: true
        });

        marker._ringType = 'outer';
        marker._ringIndex = 0;
        marker._pointIndex = i;

        marker.on('dragend', (e) => {
            const m = e.target;
            const pos = m.getLatLng();
            outerCoords[m._pointIndex] = { lat: pos.lat, lng: pos.lng };
            draw();
        });

        outerMarkers.push(marker);
        if (showPins) {
            geofenceLayer.addLayer(marker);
        }
    });

    // Build inner markers
    innerRings.forEach((ring, rIndex) => {
        ring.forEach((c, i) => {
            const marker = L.marker([c.lat, c.lng], {
                draggable: true,
                icon: L.divIcon({
                    className: 'inner-marker-icon',
                    html: '<div style="background:#e74c3c;border-radius:50%;width:14px;height:14px;border:2px solid white;box-shadow:0 0 2px rgba(0,0,0,0.5);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            });

            marker._ringType = 'inner';
            marker._ringIndex = rIndex;
            marker._pointIndex = i;

            marker.on('dragend', (e) => {
                const m = e.target;
                const pos = m.getLatLng();
                innerRings[m._ringIndex][m._pointIndex] = { lat: pos.lat, lng: pos.lng };
                draw();
            });

            innerMarkers[rIndex].push(marker);
            if (showPins) {
                geofenceLayer.addLayer(marker);
            }
        });
    });

    // Build polygon with holes if outerCoords has at least 3 points
    if (outerCoords.length >= 3) {
        const outerLatLngs = outerCoords.map(c => [c.lat, c.lng]);

        const holes = innerRings
            .filter(ring => ring.length >= 3)
            .map(ring => ring.map(c => [c.lat, c.lng]));

        const polygon = L.polygon([outerLatLngs, ...holes], {
            color: '#27ae60',
            weight: 2,
            fillColor: 'rgba(46, 204, 113, 0.3)',
            fillOpacity: 0.3
        });

        geofenceLayer.addLayer(polygon);
    }

    listUpdate();
}

// Clear all geometry
function clearCoords() {
    outerCoords = [];
    innerRings = [];
    outerMarkers = [];
    innerMarkers = [];
    currentInnerRing = -1;

    if (geofenceLayer) geofenceLayer.clearLayers();
    listUpdate();
}

// Show/hide pins
function showHide() {
    showPins = !showPins;
    draw();
}

// Toggle between outer and inner edit mode
function inOut() {
    const toggleBtn = document.getElementById("modeToggleBtn");

    inside = !inside;

    if (!inside) {
        toggleBtn.innerHTML = "Currently: Outer Polygon Mode";
        toggleBtn.className = "mode-button outer";
        currentInnerRing = -1; // not editing any specific inner ring
    } else {
        toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
        toggleBtn.className = "mode-button inner";

        // If no inner rings exist yet, create the first one
        if (innerRings.length === 0) {
            innerRings.push([]);
            innerMarkers.push([]);
        }
        if (currentInnerRing === -1) {
            currentInnerRing = 0;
        }
    }
    listUpdate();
}

// Delete outer coordinate by 1-based index
function deleteOuterCoord(index) {
    outerCoords.splice(index - 1, 1);
    draw();
}

// Delete inner coordinate by ring + 1-based index
function deleteInnerCoord(ringIndex, pointIndex) {
    if (!innerRings[ringIndex]) return;
    innerRings[ringIndex].splice(pointIndex - 1, 1);

    // If ring becomes empty, remove it
    if (innerRings[ringIndex].length === 0) {
        innerRings.splice(ringIndex, 1);
    }
    draw();
}

// Update the visible coordinate list
function listUpdate() {
    const element = document.getElementById("coordList");
    if (!element) return;

    element.innerHTML = "";

    // Exterior coordinates
    let p = document.createElement("p");
    p.textContent = "Exterior Coordinates:";
    element.appendChild(p);

    let n = 0;
    outerCoords.forEach((c, idx) => {
        n += 1;

        const wrapper = document.createElement("p");
        wrapper.style.display = "inline";

        const text = document.createTextNode(
            n + ". (" + c.lat.toFixed(6) + ", " + c.lng.toFixed(6) + ")   "
        );
        wrapper.appendChild(text);

        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";
        deleteButton.addEventListener("click", () => deleteOuterCoord(n));

        element.appendChild(wrapper);
        element.appendChild(deleteButton);
        element.appendChild(document.createElement("br"));
    });

    // Blank line
    element.appendChild(document.createElement("br"));

    // Inner coordinates (grouped by ring)
    let p2 = document.createElement("p");
    p2.textContent = "Inner Coordinates (holes):";
    element.appendChild(p2);

    if (innerRings.length === 0) {
        const none = document.createElement("p");
        none.textContent = "No inner polygons yet.";
        element.appendChild(none);
        return;
    }

    innerRings.forEach((ring, rIndex) => {
        const ringHeader = document.createElement("p");
        ringHeader.style.fontWeight = "600";
        ringHeader.textContent = "Inner Polygon " + (rIndex + 1) + ":";
        element.appendChild(ringHeader);

        let m = 0;
        ring.forEach((c, idx) => {
            m += 1;

            const wrapper = document.createElement("p");
            wrapper.style.display = "inline";

            const text = document.createTextNode(
                m + ". (" + c.lat.toFixed(6) + ", " + c.lng.toFixed(6) + ")   "
            );
            wrapper.appendChild(text);

            const deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete";
            deleteButton.addEventListener("click", () => deleteInnerCoord(rIndex, m));

            element.appendChild(wrapper);
            element.appendChild(deleteButton);
            element.appendChild(document.createElement("br"));
        });

        element.appendChild(document.createElement("br"));
    });
}

// Download CSV with OUTER and INNER sections
function download_csv_file() {
    let CSV = "";

    CSV += "OUTER\n";
    outerCoords.forEach(c => {
        CSV += c.lat + "," + c.lng + "\n";
    });

    CSV += "INNER\n";
    innerRings.forEach(ring => {
        ring.forEach(c => {
            CSV += c.lat + "," + c.lng + "\n";
        });
    });

    if (CSV.trim() === "OUTER\nINNER") {
        alert("No coordinates to download!");
        return;
    }

    const coordFile = document.createElement('a');
    coordFile.href = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);
    coordFile.target = '_blank';

    let inputName = document.getElementById("filename").value;
    if (!inputName) inputName = "coordinates";

    coordFile.download = inputName + '.csv';
    coordFile.click();
}
</script>

</body>
</html>
