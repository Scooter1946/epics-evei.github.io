<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> <!-- Needed to show map through github pages -->
    <title>Geofence Creator</title>
    <meta charset="utf-8" /> <!-- Needed to show map through github pages -->
    <style>
        /* Global Styles */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* (No dark mode / undo UI styles) */

        /* Header Styles */
        .site-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #2980b9 100%);
            position: relative;
            color: white;
            padding: 40px 20px;
            margin: -20px -20px 20px -20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .site-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                rgba(255,255,255,0.03) 0px,
                rgba(255,255,255,0.03) 1px,
                transparent 1px,
                transparent 4px
            );
            pointer-events: none;
        }

        .site-header h1 {
            margin: 0;
            font-size: 3.2em;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .site-header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
        }

        /* Container Styles */
        .main-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .map-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .coordinates-container {
            width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        /* Button Styles */
        .mode-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin: 10px 0;
            width: 100%;
        }

        .mode-button.outer {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            color: white;
        }

        .mode-button.inner {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
        }

        .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .mode-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #3498db;
            color: white;
            font-weight: 500;
            margin: 5px;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* Coordinate List Styles */
        #coordList {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            height: 475px;
            overflow-y: auto;
        }

        #coordList p {
            margin: 8px 0;
        }

        .coord-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        /* Download Section Styles */
        .download-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .download-section input[type="text"] {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .download-section input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Instructions Section Styles */
        .instructions {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .instructions h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .instruction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .instruction-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .instruction-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .instructions h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 500;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-list li {
            margin-bottom: 15px;
            padding-left: 0;
        }

        .feature-title {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feature-desc {
            color: #6c757d;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .note {
            background: rgba(255, 237, 179, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .note-icon {
            color: #f39c12;
            font-size: 16px;
        }

        .note span:last-child {
            color: #666;
            font-size: 0.9em;
            flex: 1;
        }
    </style>
	<script type='text/javascript'>                                         
	
	var map;  	             // Creates variable for map
	var exteriorRing = []; 	 // Creates an array which stores all of the outside locations
	var innerRing = [];      // Creates an array which stores all of the inside locations
	var inside = false;      // Shows whether we are editing the inside or outside polygon
	var outCoordinates = []; // Coordinate array which will be exported to CSV in the end
	var inCoordinates = [];  // Coordinate array which will be exported to CSV in the end
	var outPins = [];        // List that stores Pins
	var inPins = [];         // List that stores moveable Pins
	var showPins = true;     // Boolean for whether the pins are shown or not
    
    /* Undo/Redo and dark-mode functionality removed */

	// Creates the map window
    function GetMap() {
    	setTimeout(()=> {
        	map = new Microsoft.Maps.Map('#myMap', {                   //Creates map object
				mapTypeId: Microsoft.Maps.MapTypeId.aerial,            //Sets the map type to aerial view
			});
        	Microsoft.Maps.Events.addHandler(map, 'click',getLatlng ); // Adds handler to detect clicking on map
            
            // (keyboard shortcuts removed)
        }, 500)
    }
    
	// Retrieves coordinates where user clicks
    function getLatlng(e) { 
        if (e.targetType == "map") {
           var point = new Microsoft.Maps.Point(e.getX(), e.getY());
           var locTemp = e.target.tryPixelToLocation(point);
           var location = new Microsoft.Maps.Location(locTemp.latitude, locTemp.longitude);
			//alert(locTemp.latitude+" & "+locTemp.longitude);     // Use to easily test coordinate output
			addCoordinate(locTemp.latitude, locTemp.longitude);
			draw();
        }
    }
    
	// Add coordinate to lists when user clicks
    function addCoordinate(lat, lon){
            // Add to the outside polygon
            if (inside == false) {
			// Creates pin object
			var pin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(lat, lon), {
    			draggable: true,
        	    text: "" + (outCoordinates.length + 1),       // Number that will be visible on pin
        	    color: 'green'
        	});
			outPins.push(pin);                                // Adds pin to pin list
			// Adds pins to map, and create list of coordinates for polygon outline
        	for (let i = 0; i < outPins.length; i++){
        		exteriorRing.push(outPins[i].getLocation());  // Adds pin location to exteriorRing object, which creates the filled in polygon
        	}
		}
		
		// Add to the inside polygon
		else{
			// Creates pin object
			var pin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(lat, lon), {
    			draggable: true,
        	    text: "" + (inCoordinates.length + 1),    // Number that will be visible on pin
        	    color: 'red'
        	});
			inPins.push(pin);                             // Adds pin to pin list
			
			// Adds pins to map, and create list of coordinates for polygon outline
        	for (let i = 0; i < inPins.length; i++){
        		innerRing.push(inPins[i].getLocation());  // Adds pin location to exteriorRing object, which creates the filled in polygon
        	}
		}
	}
	
	// Draws the polygon and pins on the map
	function draw(){
		map.entities.clear();    // Clears map
    	exteriorRing = [];       // Clears exteriorRing location list
    	innerRing = [];          // Clear innerRing location list
    	
    	// Fills exteriorRing location list with outer pin coordinates
        for (let i = 0; i < outPins.length; i++){
        	exteriorRing.push(outPins[i].getLocation());
        }
    	// Fills innerRing location list with inner pin coordinates
        for (let i = 0; i < inPins.length; i++){
        	innerRing.push(inPins[i].getLocation());
        }
        
    	//Create a polygon based off of exteriorRing array
    	var outPolygon = new Microsoft.Maps.Polygon(exteriorRing, { //Creates polygon object with array of coordinates at input
       		fillColor: 'rgba(46, 204, 113, 0.3)',
       		strokeColor: '#27ae60',
       		strokeThickness: 2
   		});
    	
    	//Create a polygon based off of innerRing array
    	if (innerRing.length != 0){
    		var inPolygon = new Microsoft.Maps.Polygon(innerRing, { //Creates polygon object with array of coordinates at input
        		fillColor: 'rgba(231, 76, 60, 0.3)',
       	 		strokeColor: '#c0392b',
        		strokeThickness: 2
    		});
		}
    	
		// Creates array of coordinates for the website coordinate list
		outCoordinates = [];
        for (let i = 0; i < outPins.length; i++){
        	outCoordinates.push([[outPins[i].getLocation().latitude], [outPins[i].getLocation().longitude]]);
        }
		
		// Creates array of coordinates for the website coordinate list
		inCoordinates = [];
        for (let i = 0; i < inPins.length; i++){
        	inCoordinates.push([[inPins[i].getLocation().latitude], [inPins[i].getLocation().longitude]]);
        }
		listUpdate();    // Now that we have our coordinate lists, show these on the right side
		
		// Update pin numbers, needed if a specific pin is deleted
		outPins = [];
		inPins = [];
		for (let i = 0; i < outCoordinates.length; i++){
			var pin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(outCoordinates[i][0], outCoordinates[i][1]), {
    			draggable: true,
    	        text: "" + (i+1),
    	        color: "#27ae60"
    	    });
			outPins.push(pin);
			Microsoft.Maps.Events.addHandler(pin, 'dragend', function () {draw(); });
		}	
		for (let i = 0; i < inCoordinates.length; i++){
			var pin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(inCoordinates[i][0], inCoordinates[i][1]), {
    			draggable: true,
    	        text: "" + (i+1),
    	        color: "#c0392b"
    	    });
			inPins.push(pin);
			Microsoft.Maps.Events.addHandler(pin, 'dragend', function () {draw(); });
		}	     
		
		//Add pins to map
		if (showPins == true){
        	map.entities.push(outPins);
        	map.entities.push(inPins);
		}
		
        //Add the polygon to map
        map.entities.push(outPolygon);
        map.entities.push(inPolygon);
	}
	
	// Generates and downloads the CSV file
	function download_csv_file() {  
	  
	    // CSV array that will be downloaded
	    var CSV = [];
	    
	    // Creates header for outer coordinates in CSV file
	    CSV += "OUTER";
	    CSV += "\n";
	    
	    // merge the data with CSV  
	    outCoordinates.forEach(function(row) {  
	            CSV += row.join(',');  
	            CSV += "\n";  
	    });
	    
	    // Creates header for inner coordinates in CSV file
	    CSV += "INNER";
	    CSV += "\n";
	    
	    // merge the data with CSV  
	    inCoordinates.forEach(function(row) {  
	            CSV += row.join(',');  
	            CSV += "\n";  
	    });  
	    
	    var coordFile = document.createElement('a');  
	    coordFile.href = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);
	    coordFile.target = '_blank';  
	      
	    //Take input name from textbox next to download button, if empty sets to default name
	    var inputName = document.getElementById("filename").value;
	    if (inputName == ''){
	    	inputName = 'coordinates';
	    }
	    
	    //provide the name for the CSV file to be downloaded  
	    coordFile.download = inputName + '.csv';
	    coordFile.click();
	}
	
	// Clears coordinate lists and map
	function clearCoords() {
		exteriorRing = [];
		innerRing = [];
		outCoordinates = [];
		inCoordinates = [];
		outPins = [];
		inPins = [];
    	map.entities.clear()
		listUpdate();
	}
	
	// Deletes a specific coordinate
	function deleteCoord(index, pins){
		pins.splice(index - 1, 1);
		draw();
	}
	
	// Updates the visible coordinate list
	function listUpdate(){
		document.getElementById("coordList").innerHTML = "";
		n = 0;
		//Loops through the entire coordinates list
		// Exterior ring
		var element = document.getElementById("coordList");
		element.appendChild(document.createElement("p").appendChild(document.createTextNode("Exterior Coordinates:")));
		//Makes new Line
		var newLine = document.createElement("p");
		var text = document.createTextNode("\n");
		newLine.appendChild(text);
		element.appendChild(newLine);
		outCoordinates.forEach(function(row) {  
			n+=1;
			
			//Creates paragraph listing latitude and longitude
			var coords = document.createElement("p");
			coords.style.display = "inline"; //Allows the buttons to be next to the text
			var text = document.createTextNode(n + ". (" + row[0] + ", " + row[1] + ")\t\t");
			coords.appendChild(text);
			   
			//Creates Delete Button
			let deleteButton = document.createElement("button");
			deleteButton.innerHTML = "Delete";
			deleteButton.name = "Delete_Button_" + n;
			deleteButton.value = n;
			deleteButton.addEventListener("click", function () {
			deleteCoord(deleteButton.value, outPins);
			});
			
			//Makes new Line
			var newLine = document.createElement("p");
			var text = document.createTextNode("\n");
			newLine.appendChild(text);
			
			//Appends to the div class(under "List of coordinates:")
			element.appendChild(coords);
			element.appendChild(deleteButton); 
			element.appendChild(newLine);
  		});  
		
		// Inner ring
		// Inner ring header
		element.appendChild(document.createElement("p").appendChild(document.createTextNode("Inner Coordinates:")));
		//Makes new Line
		var newLine = document.createElement("p");
		var text = document.createTextNode("\n");
		newLine.appendChild(text);
		element.appendChild(newLine);
		n = 0;
		inCoordinates.forEach(function(row) {  
			n+=1;
			
			//Creates paragraph listing latitude and longitude
			var coords = document.createElement("p");
			coords.style.display = "inline"; //Allows the buttons to be next to the text
			var text = document.createTextNode(n + ". (" + row[0] + ", " + row[1] + ")\t\t");
			coords.appendChild(text);
			   
			//Creates Delete Button
			let deleteButton = document.createElement("button");
			deleteButton.innerHTML = "Delete";
			deleteButton.name = "Delete_Button_" + n;
			deleteButton.value = n;
			deleteButton.addEventListener("click", function () {
			deleteCoord(deleteButton.value, inPins);
			});
			
			//Makes new Line
			var newLine = document.createElement("p");
			var text = document.createTextNode("\n");
			newLine.appendChild(text);
			
			//Appends to the div class(under "List of coordinates:")
			var element = document.getElementById("coordList");
			element.appendChild(coords);
			element.appendChild(deleteButton); 
			element.appendChild(newLine);
  		});  
	}
	
	// Toggles whether the pins are being show on the map
	function showHide()
	{
		if (showPins == true){
			showPins = false;
	        for (let i = 0; i < outPins.length; i++){
	        	outPins[i].setOptions({ visible: false });
	        }
	        for (let i = 0; i < inPins.length; i++){
	        	inPins[i].setOptions({ visible: false });
	        }
			draw();
		}
	    else{
			showPins = true;
	        for (let i = 0; i < outPins.length; i++){
	        	outPins[i].setOptions({ visible: true });
	        }
	        for (let i = 0; i < inPins.length; i++){
	        	inPins[i].setOptions({ visible: true });
	        }
			draw();
	    }
	}
	
	// Toggles whether we are editing the inside or outside polygon
	function inOut()
	{
		const toggleBtn = document.getElementById("modeToggleBtn");
		
		if (inside == true){
			inside = false;
			toggleBtn.innerHTML = "Currently: Outer Polygon Mode";
			toggleBtn.className = "mode-button outer";
		}
	    else{
	    	inside = true;
			toggleBtn.innerHTML = "Currently: Inner Polygon Mode";
			toggleBtn.className = "mode-button inner";
	    }
	}
	
    </script>
    <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AuVQsmBa4y5laNovY6SJpXohxaDHbRI0kR8nZcw2lGNxQiQG6jV_Dax7sJMdDmju' async defer></script>
</head>
<body>
	
    <!-- Website header -->
    <header class="site-header">
        <h1>Geofence Creator</h1>
    </header>

    <!-- Main content container -->
    <div class="main-container">
        <!-- Map container -->
        <div class="map-container">
            <div id="myMap" style="width:100%;height:600px;"></div>
        </div>

        <!-- Coordinates container -->
        <div class="coordinates-container">
            <h2>List of coordinates</h2>
            
            <!-- Coordinate list -->
            <div id="coordList"></div>
            
            <!-- Control buttons -->
            <div class="control-buttons">
                <button onclick="clearCoords()">Clear All</button>
                <button onclick="showHide()">Show/Hide Pins</button>
                <button id="modeToggleBtn" class="mode-button outer" onclick="inOut()">Currently: Outer Polygon Mode</button>
            </div>
        </div>
    </div>

    <!-- Download section -->
    <div class="download-section">
        <button onclick="download_csv_file()">Download CSV File</button>
        <input type="text" placeholder="coordinates" id="filename">.csv
    </div>

    <!-- Instructions section -->
    <div class="instructions">
        <h2>Instructions</h2>
        <div class="instruction-grid">
            <!-- Map Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üó∫Ô∏è</i>
                    <h3>Map Controls</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Navigation:</span>
                        <span class="feature-desc">Hold and drag to pan, scroll to zoom</span>
                    </li>
                    <li>
                        <span class="feature-title">Drawing:</span>
                        <span class="feature-desc">Click to place points and create polygon outline</span>
                    </li>
                    <li>
                        <span class="feature-title">Pin Management:</span>
                        <span class="feature-desc">Drag pins to adjust positions</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Coordinate accuracy may vary in Birds Eye View</span>
                    </li>
                </ul>
            </div>

            <!-- Coordinates Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìç</i>
                    <h3>Coordinate Management</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">Display:</span>
                        <span class="feature-desc">View numbered points with lat/long coordinates</span>
                    </li>
                    <li>
                        <span class="feature-title">Controls:</span>
                        <span class="feature-desc">Delete individual points, clear all, or toggle pin visibility</span>
                    </li>
                    <li>
                        <span class="feature-title">Boundaries:</span>
                        <span class="feature-desc">Switch between inner and outer polygon creation</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Create outer boundary before inner boundary</span>
                    </li>
                </ul>
            </div>

            <!-- CSV Export Section -->
            <div class="instruction-section">
                <div class="section-header">
                    <i class="section-icon">üìä</i>
                    <h3>Data Export</h3>
                </div>
                <ul class="feature-list">
                    <li>
                        <span class="feature-title">File Format:</span>
                        <span class="feature-desc">CSV with latitude and longitude columns</span>
                    </li>
                    <li>
                        <span class="feature-title">Naming:</span>
                        <span class="feature-desc">Custom filename (default: coordinates.csv)</span>
                    </li>
                    <li>
                        <span class="feature-title">Structure:</span>
                        <span class="feature-desc">Separate sections for inner and outer boundaries</span>
                    </li>
                    <li class="note">
                        <span class="note-icon">üìù</span>
                        <span>Compatible with Excel and similar applications</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</pre>

</html>
